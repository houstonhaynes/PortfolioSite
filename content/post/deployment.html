---
title: "Local Deployment to Azure Static Site with GitHub Actions"
output:
  blogdown::html_page:
    toc: false
    toc_depth: 1
    fig_width: 8
    dev: "svg"
author: "Houston Haynes"
date: '2020-10-11T15:59:43+05:30'
featuredpath: img
featured: deployment.png
ogfeatured: H3_og_wide_deployment.png
emblem: cloud.png
description: Hacking my local R/blogdown deployment process with PowerShell
draft: false
tags:
- R
- blogdown
- PowerShell
- GitHub Actions
- deployment
categories: 
- Sidebar
weight: 1
editor_options: 
  chunk_output_type: inline
---



<div id="in-search-of-repeatability" class="section level1">
<h1>In Search of Repeatability</h1>
<p>There are some trade-offs with a static site. It’s faster and has a lighter footprint.</p>
<div id="groundwork" class="section level2">
<h2>Groundwork</h2>
<p>Here is the header embed for the CSS file - note that the entry is disabled by default. And of course it should be placed <em>after</em> your main theme CSS declaration in the header of your page. Note that even though it’s empty here, the value for ‘disabled’ is set within the dark-mode-listener JavaScript file.</p>
<figure>
<figcaption class="caption">
.gitignore entry to exclude local properties file
</figcaption>
<pre><code class="">deploy/properties.json</code></pre>
</figure>
<p>This is some text</p>
<figure>
<figcaption class="caption">
build-int.R - runs Rterm session to build blogdown site
</figcaption>
<pre><code class="r">setwd ("c:/repo/portfoliosite")
blogdown::hugo_cmd(shQuote(c('-b', 'https://int.h3tech.dev')))
q("no")</code></pre>
</figure>
<p>And below is the base CSS setup that changes the base elements. There are some exceptions to this that I’ll outline later.</p>
<figure>
<figcaption class="caption">
push.ps1 - build and deployment script
</figcaption>
<pre><code class="powershell">Param
    (
        # environment help description
        [Parameter(Mandatory=$true)]   
        [ValidateNotNull()]
        [ValidateNotNullOrEmpty()]        
        [string]$environment = $args[0]
    )

# get connection strings from local file
$JSON = Get-Content -Path "C:\repo\PortfolioSite\deploy\properties.json" | ConvertFrom-JSON

# populate connection strings for each environment
$intString = $JSON.int
$prdString = $JSON.prd

# clear the files to ensure that a 'clean' build is generated for all files
Remove-Item C:\repo\PortfolioSite\public\* -Recurse -Force

# run R terminal to build blogdown site for specific URL pattern
If ($environment -eq 'prd') {
    cmd.exe /C '"C:\Program Files\Microsoft\R Open\R-4.0.2\bin\x64\Rscript.exe" build-prd.R'
} else {
    cmd.exe /C '"C:\Program Files\Microsoft\R Open\R-4.0.2\bin\x64\Rscript.exe" build-int.R'
}

# correct iframe embed bug in the widgetframe R package - this is the workaround
Get-ChildItem  -Path c:\repo\PortfolioSite\public\*.html -recurse | ForEach { If (Get-Content $_.FullName | Select-String -Pattern '/figure-html//widgets/') 
           {(Get-Content $_ | ForEach {$_ -replace '/figure-html//widgets/', '/figure-html/widgets/'}) | Set-Content $_ } }

# do the file push using azcopy sync function
If ($environment -eq 'prd') {
    az storage blob sync -c '$web' -s "C:\repo\PortfolioSite\public" --connection-string $prdString
} else {
    az storage blob sync -c '$web' -s "C:\repo\PortfolioSite\public" --connection-string $intString
}

# clear the CDN cache so that new files show on the site
az cdn endpoint purge -g h3tech -n h3techdevCDN$environment --profile-name h3tech --content-paths '/*'</code></pre>
</figure>
</div>
<div id="actions-overt-and-implied" class="section level2">
<h2>Actions, overt and implied</h2>
<p>On page load, the “setDefaultMode” function checks for an existing localStorage setting (ostensibility from a previous user action which set the value). If that’s not found then it bases the “disabled” true/false setting in the header on whether the browser or OS preference is present. That’s used by checking the darkMediaQuery constant. So where the user had set dark mode as the default for the browser or OS, then the page would simply follow suit without a direct action by the user. Unfortunately the code is a bit more convoluted than one might expect. There’s a listener that checks for changes to that top-level setting, so that if the user switches between light and dark mode on their device that the page will continue to follow the default. But it’s not quite that easy. As it turns out, Safari is behind the rest of the web world and continues to use a deprecated “addListener” method instead of the standard “addEventListener”. That’s the genesis of the <em>try-catch-catch</em> function, where when the first event “falls through” on Safari, the first catch enables the listener to function in that browser.</p>
<p>I tested a version of this without the deprecated “addListener” against the latest version of Safari on iOS 14 and it worked. So I expect other versions of Safari to “catch up” eventually. In that case the “try” still applies and all will be well. Such as it is, this is an object lesson in how there’s still some fragmentation out there for support of accessibility features. And well - while it will continue to get better - that’s just the nature of the web.</p>
</div>
<div id="late-additions" class="section level2">
<h2>Late Additions</h2>
<p>Because of wanting to allow for that “following the default setting” behavior I had to add a reset control. This clears any localStorage value and the listener takes whatever was set on the browser or OS level. As for how it’s displayed, there was a bit of arm-wrestling with Bootstrap to get the contol to appear in a way that was integral with the dark/light mode switch. The end result displays as part of the dark mode control without crowding the menu with yet another “button”.</p>
{{% fancybox "/img" "reset-closeup.png" %}}
</div>
<div id="modal-behavior" class="section level2">
<h2>Modal Behavior</h2>
<p>Originally I had set the behavior to simply “flip the switch” when the reset control was activated. When the “reset” toggle was clicked the site would “snap” to that setting as quickly as the CSS changes could be rendered on the canvas. However the behavior in certain browsers is not exactly as expected, since it’s possible that the localStorage value and system-set value could match. Also, there are settings on the browser level that can sometimes conflict with the OS-level setting (which I found on mobile devices when testing) that meant the user could end up with a confusing end result. If the browser was still set to the same mode as the localStorage setting, and the OS was set to the opposite value, the user would see <em>no</em> change in the browser canvas. The prompt in the modal is there to add some context to this multi-tiered control.</p>
{{% fancybox "/img" "reset-modal.png" %}}
<p>While the standard “Close” and “times” buttons are on the modal, it’s also set to clear on any click within the desktop space. It’s not really dependent on the user confirming the modal for any behavior to change. I did that as a measure of convenience, but am also aware that it too might cause some confusion. Either way, once the top-level experience was in-hand I could deal with some unintended consequences with various elements inside the page. It can feel like a “game of whack-a-mole” but the end result was worth the effort.</p>
</div>
<div id="masking-dark-mode-in-media-embeds" class="section level2">
<h2>Masking dark mode in media embeds</h2>
<p>I take advantage of Hugo’s built-in templates for Vimeo and Twitter post embeds. But that has an unintended consequence of creating a “photo negative” effect for videos and image thumbnails in Twitter posts. I could have stayed with simply masking the changes for those embeds with a “not” clause in the CSS. But in this case I wanted to tweak things a bit by reducing the brightness and contrast for a truer “dark mode” experience.</p>
<figure>
<figcaption class="caption">
Vimeo and Twitter ‘exclusion’ in dark.css
</figcaption>
<pre><code class="css">iframe[src^="https://player.vimeo.com/video"],
iframe[src^="https://platform.twitter.com"] {
    filter: invert(100%) hue-rotate(180deg) brightness(75%) contrast(90%);
    -webkit-filter: invert(100%) hue-rotate(180deg) brightness(75%) contrast(90%);
}</code></pre>
</figure>
<p>I was tempted to “surface” the internal Vimeo and Twitter embed templates in Hugo and modify them for my site. But again, I’m trying to split the difference between honoring the spirit of this browser feature set without overinvesting for what amounts to a personal tech vanity site. Considering usability issues like this have shifted “dark mode” from a convenience feature and more about how users who <em>need</em> this functionality can better interact with the site. This is still a burgeoning field within the web community, and I’ll continue to refactor to make the site better suited to <em>“a11y”</em> standards as I learn work more with Hugo. (or when I transition to another framework which makes this more manageable)</p>
</div>
<div id="desktop-versus-mobile-dark-mode-preferences" class="section level2">
<h2>desktop versus mobile dark mode preferences</h2>
<p>As mentioned above with the modal, I mistakenly believed that the OS-level listener was the only setting I had to account for. As it turns out there are also mobile settings in the browser and the device level settings.</p>
{{% fancybox "/img" "reset-mobileOS.png" %}}
<p>And here’s the setting in Chrome for my Samsung Note10+. I noticed that this is only available in the mobile app. No equivalent setting exists in Chrome desktop.</p>
{{% fancybox "/img" "reset-mobileOSDefault.jpg" %}}
<p>And beyond the device settings Samsung provides a control in their Bixby applet. I was able to put a widget that could flip the value manually without diving into device settings. And while this can be triggered based on a variety of conditions, here I’m simply using it for testing purposes.</p>
{{% fancybox "/img" "reset-mobileLightDark.jpg" %}}
<p>So while the solution makes a good-faith-effort to provide a smooth user experience, there’s still quite a bit of fragmentation in the marketplace. Different operating systems, browsers and devices approach accessibility their own way. And I expect that will continue to be the case as standards and practices are sorted out.</p>
</div>
<div id="future-tweaks-and-re-engineering" class="section level2">
<h2>Future Tweaks and Re-Engineering</h2>
<p>This has been a good start, but more work remains to be done. The gray background for charts and code blocks (that I thought would be “easy on the eyes”) actually creates a low contrast experience that’s antagonistic to certain conditions and communities. Fortunately some of these things can be adjusted by simply selected a new “theme” that has a better default accessibility posture. In other cases I’ll have to “get under the hood” and re-tool some of my R-based and Highcharts-rendered reports. That work is continuing now.</p>
</div>
</div>
<div id="another-beginning" class="section level1">
<h1>Another Beginning</h1>
<p>As usual, what started as “simple” will require more thought and work, and fortunately there are quite a few tools online to help with that process. I’m a huge fan of <a href="http://paletton.com/" target="_blank">paletton</a> not only for evaluating color schemes, but also for its vision simulator.</p>
{{% fancybox "/img" "reset-visionSimulator.png" %}}
<p>If you’re looking at the low contrast between the menus and the text, the irony of that is not lost on me, either. Still it’s an invaluable tool for checking color choices against the ability for people with different conditions to pick up the nuances in your color palette. There’s also <a href="https://webaccessibility.com/" target="_blank">the webaccessibility site</a> also offers an initially free service which checks a wide variety of web settings. And a web search reveals a plethora of options, and I expect this only to become more common as standards and practices emerge.</p>
<p>This will continue to be a developing topic and I’m looking forward to moving past the “convenience feature” of dark mode and make the site more accessible to everyone.</p>
</div>
